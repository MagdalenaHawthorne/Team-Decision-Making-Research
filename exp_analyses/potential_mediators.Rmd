---
title: "Mediators"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
## libraries

```{r}
library(readr)
library(tidyverse)
library(psych)
library(mediation)
library(broom)
```
## load data

```{r}
group_df <- read_csv("data/group_level_data.csv")
indiv_df <- read_csv("data/indiv_level_data.csv")
```
## drop groups to be excluded

```{r}
group_df <- group_df %>% 
  filter(!group %in% c(14, 80))
indiv_df <- indiv_df %>% 
  filter(!group %in% c(14, 80))

```
## merge data frames

```{r}
big_df <- indiv_df %>% 
  left_join(group_df, by = "group")

#View(big_df)

```
## create new columns

```{r}
big_df <- big_df %>% 
  separate(condition, c('group_structure','TMS'), sep = '_', remove = FALSE) %>%
  mutate(binary_decision = decision == "C")
```
# check out confidence in decision by condition (but probably move it to another file)

```{r}
# calculate average per group first
big_df <- big_df %>% 
  group_by(group) %>% 
  mutate(avg_confidence = mean(confidence_decision)) %>% 
  ungroup()

# is there a difference between conditions? LINEAR REGRESSION

# 1. comparing all at once
# big_df %>% do(tidy(lm(avg_confidence ~ condition, data = big_df))) 

decision_conf_all <- lm(avg_confidence ~ condition, data = big_df); summary(decision_conf_all)

# !!!!! DIRECTLY WITHOUT AVG CALCULATION: summary(lm(confidence_decision ~ group_structure, data = big_df))

# have a look at the numbers
big_df %>% 
  group_by(condition) %>% 
  summarise(decision_confidence = mean(avg_confidence))

# 2. comparing hierarchical and self-organized
decision_conf_structure <- lm(avg_confidence ~ group_structure, data = big_df); summary(decision_conf_structure) # => significant: self-organized groups were more confident in their group decision!

# 3. comparing TMS and no TMS
decision_conf_TMS <- lm(avg_confidence ~ TMS, data = big_df); summary(decision_conf_TMS) # => NOT significant!

```
# general (single-item) motivation 

```{r}
# calculate average fist
big_df <- big_df %>% 
  group_by(group) %>%
  mutate(avg_motivation = mean(gen_motivation))

# compare motivation 
big_df %>% 
  group_by(condition) %>% 
  summarise(gen_mot = mean(avg_motivation))
# => it looks like only group structure might have had an effect on motivation

overall_motivation <- lm(avg_motivation ~ group_structure, data = big_df)
summary(overall_motivation)
t.test(avg_motivation ~ group_structure, data = big_df)
# => self-organized groups reported higher motivation !!
```
# group identification

## preparations: aggragating over single items 

```{r}

# calculate overall score
big_df <- big_df %>% 
  ungroup() %>% 
  mutate(overall_group_identification = rowMeans(.[ , c('group_ident_1', 'group_ident_2', 'group_ident_3', 'group_ident_4')]))

big_df

# calculating average group identification per group 
big_df <- big_df %>% 
  group_by(group) %>% 
  mutate(group_ident_per_group = mean(overall_group_identification))
```
## test whether conditions predict group identification 

```{r}

summary(lm(overall_group_identification ~ condition, data = big_df)) 

summary(lm(overall_group_identification ~ group_structure, data = big_df)) # significant!!

summary(lm(overall_group_identification ~ TMS, data = big_df)) # NOT signif.!!

```

## Mediation analyses to see whether group identification mediates the effect of group structure on decision outcome 

```{r}

med.model <- lm(overall_group_identification ~ group_structure, data= big_df)
full.model <- glm(binary_decision ~ overall_group_identification + group_structure, data = big_df, family = 'binomial')
m.out <- mediate(med.model, full.model, treat = "group_structure", mediator = "overall_group_identification", boot = TRUE, sims = 999)
summary(m.out)
plot(m.out)

# on the group level
med.model <- lm(group_ident_per_group ~ group_structure, data= big_df)
full.model <- glm(binary_decision ~ group_ident_per_group + group_structure, data = big_df, family = 'binomial')
m.out <- mediate(med.model, full.model, treat = "group_structure", mediator = "group_ident_per_group", boot = TRUE, sims = 999)
summary(m.out)
plot(m.out)

```

# open communication

## reverse coding of item 4

```{r}
big_df <- big_df %>% 
  mutate(open_comm_4_recoded = 7 - open_comm_4)

```
## calculate average of open communication per participant

```{r}
big_df <- big_df %>% 
  mutate(open_comm_1 = as.numeric(open_comm_1), open_comm_2 = as.numeric(open_comm_2), open_comm_3 = as.numeric(open_comm_3), open_comm_4_recoded = as.numeric(open_comm_4_recoded))

big_df <- big_df %>% 
  ungroup()

# 1. possibility
big_df <- big_df %>% 
  mutate(avg_open_comm = rowMeans(.[, c("open_comm_1", "open_comm_2", "open_comm_3", "open_comm_4_recoded")]))

# 2. possibility
# big_df <- big_df %>% 
#  dplyr::select(c(open_comm_1, open_comm_2, open_comm_3, open_comm_4_recoded)) %>% 
#  mutate(avg_open_comm = rowMeans(.))

# 3.possibility 
#big_df <- big_df %>% 
#  rowwise() %>% 
#   mutate(avg_open_comm = mean(c(open_comm_1, open_comm_2, open_comm_3, open_comm_4_recoded)))


big_df <- subset(big_df, select = -c(open_comm_1, open_comm_2, open_comm_3, open_comm_4, open_comm_4_recoded))

big_df

?transmute  
```
# calculate group average

```{r}

big_df <- big_df %>% 
  group_by(group, group_structure, TMS) %>% 
  mutate(group_avg_open_comm = mean(avg_open_comm))

smaller_df <- big_df %>% 
  group_by(group, group_structure, TMS) %>% 
  summarise(group_avg_open_comm = mean(avg_open_comm))

smaller_df %>% 
  group_by(group_structure) %>% 
  summarise(overall_open_comm = mean(group_avg_open_comm))
```
# test potential group differences
```{r}
summary(lm(group_avg_open_comm ~ group_structure, data = smaller_df)) # significant
summary(lm(group_avg_open_comm ~ TMS, data = smaller_df)) # not sign.
summary(lm(group_avg_open_comm ~ group_structure * TMS, data = smaller_df)) 

```
# BRING INFORAMTION EXCHANGE TO THE TABLE!!!

## load data

```{r}
load("shared_unshared_information.RData")
```
## combine shared information bias with mediators data frame

```{r}
shared_mentioning_bias

combined_df <- left_join(big_df, shared_mentioning_bias[ , c("group", "bias")], by = 'group') 

combined_df <- combined_df %>% 
  rename(mentioning_bias = `bias.y`)

shared_repetition_bias <- shared_repetition_bias %>% 
  rename(repetition_bias = bias)

combined_df <- distinct(combined_df)
View(combined_df)
```
## see if group identification / open communication predicts mentioning bias

```{r}
summary(lm(mentioning_bias ~ overall_group_identification, data = combined_df)) # IT DOES!

summary(lm(mentioning_bias ~ avg_open_comm, data = combined_df)) # IT DOES!

```
## It's time for mediation: is the difference between hierarchical & self-organized groups in terms of shared information (only mentioning_bias relevant) mediated by ...

### first, group identification

```{r}

med.model <- lm(overall_group_identification ~ group_structure, data= combined_df)
full.model <- lm(mentioning_bias ~ overall_group_identification + group_structure, data = combined_df)
m.out <- mediate(med.model, full.model, treat = "group_structure", mediator = "overall_group_identification")
summary(m.out)
plot(m.out) # NOPE

# try decision as oucome
med.model <- lm(overall_group_identification ~ group_structure, data= combined_df)
full.model <- lm(binary_decision ~ overall_group_identification + group_structure, data = combined_df)
m.out <- mediate(med.model, full.model, treat = "group_structure", mediator = "overall_group_identification")
summary(m.out)
plot(m.out)
```
## second, open communication 

```{r}
med.model <- lm(group_avg_open_comm ~ group_structure, data= combined_df)
full.model <- lm(mentioning_bias ~ group_avg_open_comm + group_structure, data = combined_df)
m.out <- mediate(med.model, full.model, treat = "group_structure", mediator = "group_avg_open_comm")
summary(m.out)
plot(m.out) 
# significant if aggregation on the group level is used

# BUT:

med.model <- lm(avg_open_comm ~ group_structure, data= combined_df)
full.model <- lm(mentioning_bias ~ avg_open_comm + group_structure, data = combined_df)
m.out <- mediate(med.model, full.model, treat = "group_structure", mediator = "avg_open_comm")
summary(m.out)
```


# MOTIVATION

## compile subscales

```{r}
# interest, perceived_competence, and pressure (reversed)
select <- dplyr::select

combined_df <- combined_df %>%
  ungroup() %>% 
  mutate(pressure_1_recoded = 7 - pressure_1, pressure_2_recoded = 7 - pressure_2, pressure_3_recoded = 7 - pressure_3) %>% 
  mutate(avg_interest = rowMeans(.[ , c("interest_1", "interest_2", "interest_3")])) %>% 
  mutate(avg_perceived_conf = rowMeans(select(., c("perceived_conf_1", "perceived_conf_2", "perceived_conf_3")))) %>%
  mutate(avg_pressure = rowMeans(select(., c("pressure_1_recoded", "pressure_2_recoded", "pressure_3_recoded"))))

```
## calculate scores of the total scale for each participant and per group

```{r}
combined_df <- combined_df %>% 
  ungroup() %>% 
  mutate(avg_intrinsic_mot = rowMeans(.[ , c('avg_perceived_conf', 'avg_interest', 'avg_pressure')])) %>%
  group_by(group) %>% 
  mutate(intrinsic_mot_per_group = mean(avg_intrinsic_mot))
```
## explore the subscales across conditions

```{r}
combined_df %>% 
  group_by(condition) %>% 
  summarise(group_pressure = mean(avg_pressure), group_interest = mean(avg_interest), group_perceived_conf = mean(avg_perceived_conf))
```

## now, see if there is a difference in intrinsic motivation between h and so groups

```{r}
med_df <- combined_df %>% 
  group_by(group, group_structure, TMS) %>% 
  summarise(mentioning_bias = mean(mentioning_bias), intrinsic_mot_per_group = mean(intrinsic_mot_per_group))

med_df

t.test(intrinsic_mot_per_group ~ group_structure, data = med_df)

```
## as a next step, see if intrisic motivation predicts mentioning bias

```{r}

# OH FUCK! I hadn't considered the degrees of freedom yet :(

med_2_df <- combined_df %>% 
  select(group, id, group_structure, binary_decision, mentioning_bias, avg_intrinsic_mot)

med_2_df

summary(lm(mentioning_bias ~ intrinsic_mot_per_group, data = med_df)) 

summary(lm(mentioning_bias ~ avg_intrinsic_mot, data = med_2_df)) #YUP 

```
## finally test mediation

```{r}
med_mod <- lm(avg_intrinsic_mot ~ group_structure, data = med_2_df)
full_model <- lm(mentioning_bias ~ group_structure + avg_intrinsic_mot, data = med_2_df)
med_test <- mediate(med_mod, full_model, treat = "group_structure", mediator = "avg_intrinsic_mot")
summary(med_test)
plot(med_test) # NOPE

med_mod <- lm(avg_intrinsic_mot ~ group_structure, data = med_2_df)
full_model <- lm(binary_decision ~ group_structure + avg_intrinsic_mot, data = med_2_df)
med_test <- mediate(med_mod, full_model, treat = "group_structure", mediator = "avg_intrinsic_mot")
summary(med_test)
plot(med_test) # YES !!!!

```

